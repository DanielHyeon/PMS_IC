# PMS-IC 프로젝트별 관리 현황 검토 보고서

## 문서 정보
| 항목 | 내용 |
|------|------|
| 작성일 | 2026-01-14 |
| 목적 | 기존 기능 및 신규 기능의 프로젝트별 관리 가능 여부 검토 |
| 상태 | 분석 완료 |

---

## 1. 개요

본 문서는 PMS-IC 시스템의 모든 기능이 프로젝트별로 데이터 격리 및 관리가 가능한지 검토한 결과입니다.

### 1.1 검토 범위
- 데이터베이스 Entity 관계
- Repository 쿼리 패턴
- API 엔드포인트
- Neo4j/RAG 데이터
- Frontend 상태 관리
- 신규 RFP 기능

---

## 2. 현황 분석 결과

### 2.1 전체 요약

| 영역 | 프로젝트 격리 | 상태 | 비고 |
|------|--------------|------|------|
| **Sprint/UserStory** | ✅ 완전 지원 | 양호 | project_id 기반 완전 격리 |
| **Phase/Deliverable/KPI** | ✅ 지원 | 양호 | Phase를 통한 계층적 격리 |
| **Task** | ⚠️ 부분 지원 | 개선 필요 | 직접 project_id 없음 |
| **KanbanColumn** | ✅ 완전 지원 | 양호 | project_id 직접 보유 |
| **Chat/AI 어시스턴트** | ❌ 미지원 | **심각** | 사용자 기반만 지원 |
| **Neo4j/RAG** | ❌ 미지원 | **심각** | 전역 검색만 가능 |
| **Frontend** | ❌ 미지원 | **심각** | 프로젝트 컨텍스트 없음 |

### 2.2 전체 격리 수준: **40-50%**

---

## 3. 상세 분석

### 3.1 데이터베이스 Entity 분석

#### ✅ 프로젝트 격리 완료 (5개 Entity)

| Entity | project_id | 격리 방식 |
|--------|------------|----------|
| Sprint | 직접 보유 | `@Column(name = "project_id")` |
| UserStory | 직접 보유 | `@Column(name = "project_id")` |
| Phase | 직접 보유 | `@ManyToOne @JoinColumn(name = "project_id")` |
| KanbanColumn | 직접 보유 | `@Column(name = "project_id")` |
| Deliverable | Phase 통해 | `phase_id → Phase.project_id` |
| KPI | Phase 통해 | `phase_id → Phase.project_id` |

#### ⚠️ 간접 격리 (개선 권장)

| Entity | 현재 상태 | 문제점 |
|--------|----------|--------|
| **Task** | column_id, phase_id만 보유 | 직접 프로젝트 조회 불가, 조인 필요 |

```
현재: Task → KanbanColumn → project_id (2단계 조인 필요)
권장: Task에 project_id 직접 추가
```

#### ❌ 프로젝트 격리 미지원 (심각)

| Entity | 현재 상태 | 문제점 |
|--------|----------|--------|
| **ChatSession** | user_id만 보유 | 모든 프로젝트 대화 혼재 |
| **ChatMessage** | session_id만 보유 | 프로젝트 구분 불가 |

```
현재 구조:
ChatSession: id, user_id, title, active, created_at
           ↑ project_id 없음!

권장 구조:
ChatSession: id, user_id, project_id, title, active, created_at
```

---

### 3.2 Repository 쿼리 분석

#### ✅ 프로젝트 필터링 지원

```java
// SprintRepository - 완전 지원
List<Sprint> findByProjectIdOrderByStartDateDesc(String projectId);
Optional<Sprint> findByProjectIdAndStatus(String projectId, Sprint.SprintStatus status);

// UserStoryRepository - 완전 지원
List<UserStory> findByProjectIdOrderByPriorityOrderAsc(String projectId);
List<UserStory> findByProjectIdAndStatusOrderByPriorityOrderAsc(String projectId, status);

// PhaseRepository - 완전 지원
List<Phase> findByProjectIdOrderByOrderNumAsc(String projectId);

// KanbanColumnRepository - 완전 지원
List<KanbanColumn> findByProjectIdOrderByOrderNumAsc(String projectId);
```

#### ⚠️ 프로젝트 필터링 미흡

```java
// TaskRepository - 프로젝트 필터링 없음
List<Task> findByColumnIdOrderByOrderNumAsc(String columnId);  // 컬럼 기반만
List<Task> findByAssigneeId(String assigneeId);                // 담당자 기반만
// ❌ findByProjectId() 메서드 없음

// DeliverableRepository - 프로젝트 필터링 없음
List<Deliverable> findByPhaseId(String phaseId);  // Phase 기반만
// ❌ findByProjectId() 메서드 없음

// KpiRepository - 프로젝트 필터링 없음
List<Kpi> findByPhaseId(String phaseId);  // Phase 기반만
// ❌ findByProjectId() 메서드 없음
```

#### ❌ 프로젝트 필터링 불가

```java
// ChatSessionRepository - 사용자 기반만
List<ChatSession> findByUserIdAndActiveTrueOrderByCreatedAtDesc(String userId);
// ❌ 프로젝트 필터링 완전 불가

// ChatMessageRepository - 세션 기반만
List<ChatMessage> findBySessionIdOrderByCreatedAtAsc(String sessionId);
// ❌ 프로젝트 필터링 완전 불가
```

---

### 3.3 API 엔드포인트 분석

#### ✅ 프로젝트 파라미터 필수

```java
// UserStoryController - 모범 사례
@GetMapping
public ResponseEntity<List<UserStoryResponse>> getAllStories(
    @RequestParam String projectId,  // ✅ 필수 파라미터
    @RequestParam(required = false) String status,
    @RequestParam(required = false) String epic)
```

#### ⚠️ 프로젝트 파라미터 선택적

```java
// PhaseController - 개선 필요
@GetMapping
public ResponseEntity<ApiResponse<List<PhaseDto>>> getPhases(
    @RequestParam(value = "projectId", required = false) String projectId)
    // ⚠️ projectId가 선택적 → 모든 Phase 조회 가능
```

#### ❌ 프로젝트 파라미터 없음

```java
// TaskController - 프로젝트 미지원
@GetMapping
public ResponseEntity<ApiResponse<List<Object>>> getAllTasks()
// ❌ projectId 파라미터 없음

// ChatController - 프로젝트 미지원
@PostMapping("/message")
public ResponseEntity<ApiResponse<ChatResponse>> sendMessage(@RequestBody ChatRequest request)
// ❌ projectId 파라미터 없음 → 모든 프로젝트 데이터에 AI가 접근 가능
```

---

### 3.4 Neo4j/RAG 분석

#### 현재 Neo4j 스키마

```cypher
// 현재 Document 노드 - project_id 없음
(:Document {
  doc_id: String,
  title: String,
  content: String,
  file_type: String,
  file_path: String,
  created_at: String
  // ❌ project_id 필드 없음
})

// 현재 Chunk 노드 - project_id 없음
(:Chunk {
  chunk_id: String,
  content: String,
  embedding: List<Float>
  // ❌ project_id 필드 없음
})
```

#### RAG 검색 서비스

```java
// RAGSearchService.java - 전역 검색
public List<String> searchRelevantDocuments(String query, int topK) {
    // ❌ projectId 파라미터 없음
    // ❌ 모든 프로젝트의 문서에서 검색
    // 보안 문제: 사용자가 접근 권한 없는 프로젝트 데이터 노출 가능
}
```

#### 문제점
1. **보안 취약점**: 프로젝트 A 사용자가 프로젝트 B 문서 검색 가능
2. **검색 품질 저하**: 관련 없는 프로젝트 문서가 검색 결과에 포함
3. **AI 응답 오염**: AI가 다른 프로젝트 정보를 혼합하여 응답

---

### 3.5 Frontend 분석

#### 현재 상태 관리

```typescript
// App.tsx - 프로젝트 컨텍스트 없음
export default function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState<UserInfo | null>(null);
  const [currentView, setCurrentView] = useState<View>('dashboard');
  const [aiPanelOpen, setAiPanelOpen] = useState(false);

  // ❌ currentProject 상태 없음
  // ❌ selectedProjectId 없음
}
```

#### 문제점
1. **프로젝트 선택 UI 없음**: 사용자가 작업할 프로젝트를 선택할 수 없음
2. **대시보드 데이터 혼재**: 모든 프로젝트 데이터가 집계되어 표시
3. **컨텍스트 전파 없음**: 자식 컴포넌트에 프로젝트 정보 전달 안됨

---

## 4. 신규 RFP 기능 영향 분석

### 4.1 RFP 기능의 프로젝트 격리 설계

신규 RFP 기능은 **처음부터 프로젝트 격리를 고려하여 설계**됨:

```sql
-- RFP 테이블 (설계 완료)
CREATE TABLE project.rfps (
    id VARCHAR(36) PRIMARY KEY,
    project_id VARCHAR(36) NOT NULL,  -- ✅ 프로젝트 ID 필수
    tenant_id VARCHAR(36) NOT NULL,   -- ✅ 테넌트 ID 추가
    ...
);

-- 요구사항 테이블 (설계 완료)
CREATE TABLE project.requirements (
    id VARCHAR(36) PRIMARY KEY,
    project_id VARCHAR(36) NOT NULL,  -- ✅ 프로젝트 ID 필수
    tenant_id VARCHAR(36) NOT NULL,   -- ✅ 테넌트 ID 추가
    ...
);
```

### 4.2 기존 기능과의 통합 문제

RFP 기능이 기존 기능과 통합될 때 발생할 수 있는 문제:

| 통합 영역 | 문제점 | 영향도 |
|----------|--------|--------|
| 요구사항 → Sprint 매핑 | Sprint는 격리됨, 정상 작동 | 낮음 |
| 요구사항 → Task 매핑 | Task에 project_id 없음, 조인 복잡 | 중간 |
| AI 보고서 생성 | Chat이 격리 안됨, 다른 프로젝트 데이터 혼입 가능 | **높음** |
| RAG 검색 | 프로젝트 격리 안됨, 다른 프로젝트 RFP 검색됨 | **높음** |

---

## 5. 개선 권장사항

### 5.1 필수 개선 항목 (P0)

#### 5.1.1 Neo4j 프로젝트 격리

```cypher
-- 모든 노드에 project_id 추가
(:Document {
  doc_id: String,
  project_id: String,  -- 추가
  tenant_id: String,   -- 추가
  ...
})

-- 검색 시 프로젝트 필터 적용
MATCH (d:Document {project_id: $projectId})
-[:CONTAINS]->(c:Chunk)
WHERE c.embedding <-> $queryEmbedding < $threshold
RETURN c
```

#### 5.1.2 Chat 프로젝트 격리

```java
// ChatSession Entity 수정
@Entity
public class ChatSession extends BaseEntity {
    @Column(name = "project_id")
    private String projectId;  // 추가

    @Column(name = "user_id")
    private String userId;
    // ...
}

// ChatRepository 수정
List<ChatSession> findByUserIdAndProjectIdAndActiveTrueOrderByCreatedAtDesc(
    String userId, String projectId);
```

#### 5.1.3 Frontend 프로젝트 컨텍스트

```typescript
// contexts/ProjectContext.tsx 추가
export const ProjectContext = createContext<ProjectContextType | null>(null);

export function ProjectProvider({ children }: { children: React.ReactNode }) {
  const [currentProject, setCurrentProject] = useState<Project | null>(null);
  const [projects, setProjects] = useState<Project[]>([]);

  return (
    <ProjectContext.Provider value={{ currentProject, setCurrentProject, projects }}>
      {children}
    </ProjectContext.Provider>
  );
}

// 프로젝트 선택 컴포넌트
export function ProjectSelector() {
  const { projects, currentProject, setCurrentProject } = useProjectContext();

  return (
    <Select value={currentProject?.id} onChange={(id) => setCurrentProject(id)}>
      {projects.map(p => (
        <Option key={p.id} value={p.id}>{p.name}</Option>
      ))}
    </Select>
  );
}
```

### 5.2 중요 개선 항목 (P1)

#### 5.2.1 Task에 project_id 추가

```java
// Task Entity 수정
@Entity
public class Task extends BaseEntity {
    @Column(name = "project_id")
    private String projectId;  // 추가
    // ...
}

// TaskRepository 수정
List<Task> findByProjectIdOrderByCreatedAtDesc(String projectId);
```

#### 5.2.2 RAG 검색 프로젝트 스코핑

```java
// RAGSearchService 수정
public List<String> searchRelevantDocuments(String query, String projectId, int topK) {
    // projectId 파라미터 추가
    // Neo4j 쿼리에 프로젝트 필터 적용
}
```

#### 5.2.3 API 엔드포인트 표준화

```java
// 모든 GET 엔드포인트에 projectId 필수화
@GetMapping
public ResponseEntity<ApiResponse<List<TaskDto>>> getTasks(
    @RequestParam(required = true) String projectId) {  // 필수로 변경
    return taskService.getTasksByProject(projectId);
}
```

### 5.3 권장 개선 항목 (P2)

#### 5.3.1 프로젝트 접근 권한 검증

```java
// ProjectAccessValidator 추가
@Component
public class ProjectAccessValidator {
    public void validateAccess(String userId, String projectId) {
        if (!hasAccess(userId, projectId)) {
            throw new AccessDeniedException("프로젝트 접근 권한이 없습니다.");
        }
    }
}

// AOP로 자동 검증
@Aspect
@Component
public class ProjectAccessAspect {
    @Before("@annotation(RequireProjectAccess)")
    public void validateProjectAccess(JoinPoint joinPoint) {
        // 자동 권한 검증
    }
}
```

#### 5.3.2 대시보드 프로젝트 스코핑

```typescript
// Dashboard 컴포넌트 수정
export default function Dashboard({ userRole }: { userRole: UserRole }) {
  const { currentProject } = useProjectContext();

  // 선택된 프로젝트 기준으로 데이터 로드
  const { data: metrics } = useQuery(
    ['dashboard', currentProject?.id],
    () => dashboardService.getMetrics(currentProject?.id)
  );
  // ...
}
```

---

## 6. 개선 로드맵

### Phase 0: 긴급 보안 패치

| 태스크 | 우선순위 | 설명 |
|--------|---------|------|
| RAG 검색 프로젝트 필터 | P0 | 타 프로젝트 데이터 노출 방지 |
| Chat API 프로젝트 파라미터 | P0 | AI가 타 프로젝트 정보 응답 방지 |

### Phase 1: 데이터 격리 기반

| 태스크 | 우선순위 | 설명 |
|--------|---------|------|
| ChatSession에 project_id 추가 | P0 | DB 마이그레이션 |
| Neo4j 스키마 project_id 추가 | P0 | 그래프 DB 구조 변경 |
| Task에 project_id 추가 | P1 | DB 마이그레이션 |

### Phase 2: API 계층 표준화

| 태스크 | 우선순위 | 설명 |
|--------|---------|------|
| 모든 API에 projectId 필수화 | P1 | 컨트롤러 수정 |
| Repository 메서드 추가 | P1 | findByProjectId 추가 |
| 프로젝트 접근 권한 검증 | P2 | AOP 기반 검증 |

### Phase 3: Frontend 통합

| 태스크 | 우선순위 | 설명 |
|--------|---------|------|
| ProjectContext 추가 | P1 | 전역 상태 관리 |
| 프로젝트 선택 UI | P1 | 헤더에 선택기 추가 |
| 컴포넌트 프로젝트 스코핑 | P2 | 모든 컴포넌트 수정 |

### Phase 4: RFP 기능 구현

| 태스크 | 우선순위 | 설명 |
|--------|---------|------|
| RFP 기능 구현 | P1 | 설계서 기준 구현 |
| 기존 기능과 통합 테스트 | P1 | E2E 테스트 |

---

## 7. 수정 필요 파일 목록

### 7.1 Backend 파일

| 파일 | 수정 유형 | 설명 |
|------|----------|------|
| `chat/entity/ChatSession.java` | 수정 | project_id 필드 추가 |
| `chat/repository/ChatSessionRepository.java` | 수정 | findByProjectId 메서드 추가 |
| `chat/service/ChatService.java` | 수정 | 프로젝트 스코핑 로직 |
| `chat/controller/ChatController.java` | 수정 | projectId 파라미터 추가 |
| `task/entity/Task.java` | 수정 | project_id 필드 추가 |
| `task/repository/TaskRepository.java` | 수정 | findByProjectId 메서드 추가 |
| `task/controller/TaskController.java` | 수정 | projectId 파라미터 필수화 |
| `rag/service/RAGSearchService.java` | 수정 | projectId 파라미터 추가 |
| `rag/service/RAGIndexingService.java` | 수정 | projectId 메타데이터 저장 |
| `project/controller/PhaseController.java` | 수정 | projectId 필수화 |

### 7.2 LLM Service 파일

| 파일 | 수정 유형 | 설명 |
|------|----------|------|
| `rag_service_neo4j.py` | 수정 | project_id 필터 추가 |
| `app.py` | 수정 | API에 project_id 파라미터 |

### 7.3 Frontend 파일

| 파일 | 수정 유형 | 설명 |
|------|----------|------|
| `contexts/ProjectContext.tsx` | 신규 | 프로젝트 컨텍스트 |
| `components/shared/ProjectSelector.tsx` | 신규 | 프로젝트 선택기 |
| `App.tsx` | 수정 | ProjectProvider 래핑 |
| `components/Dashboard.tsx` | 수정 | 프로젝트 스코핑 |
| `components/AIAssistant.tsx` | 수정 | projectId 전달 |
| `services/chatService.ts` | 수정 | projectId 파라미터 |

### 7.4 Database 마이그레이션

| 파일 | 설명 |
|------|------|
| `V5__add_project_id_to_chat.sql` | ChatSession에 project_id 추가 |
| `V6__add_project_id_to_task.sql` | Task에 project_id 추가 |

---

## 8. 결론

### 8.1 현재 상태 평가

- **전체 프로젝트 격리 수준**: 40-50%
- **심각한 격리 미흡 영역**: Chat, Neo4j/RAG, Frontend
- **양호한 영역**: Sprint, UserStory, Phase, KanbanColumn

### 8.2 신규 RFP 기능 영향

- RFP 기능 자체는 프로젝트 격리 설계 완료
- **단, 기존 기능 개선 없이 구현 시 보안 및 데이터 일관성 문제 발생**

### 8.3 권장 진행 순서

1. **긴급**: RAG 검색 및 Chat의 프로젝트 격리 (보안 패치)
2. **선행**: Phase 0-2 개선 작업 진행
3. **후행**: RFP 기능 구현 (Phase 4)

### 8.4 예상 추가 작업량

| 단계 | 예상 작업 |
|------|----------|
| Phase 0 (긴급 패치) | Backend 2-3일 |
| Phase 1 (데이터 격리) | Backend 3-4일, DB 마이그레이션 1일 |
| Phase 2 (API 표준화) | Backend 2-3일 |
| Phase 3 (Frontend) | Frontend 4-5일 |
| Phase 4 (RFP 구현) | 기존 계획대로 7주 |

**총 추가 예상**: 기존 기능 개선에 약 2주 추가 소요

---

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-14 | AI Assistant | 초안 작성 |
