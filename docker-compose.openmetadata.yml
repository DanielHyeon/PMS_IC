# OpenMetadata Stack for PMS-IC
# 사용법: docker-compose -f docker-compose.yml -f docker-compose.openmetadata.yml up -d
#
# 필요 환경변수 (.env에 추가):
#   OM_MYSQL_ROOT_PASSWORD=openmetadata_root_password
#   OM_MYSQL_PASSWORD=openmetadata_password
#   OM_JWT_TOKEN=<생성된 JWT 토큰>

services:
  # ============================================
  # OpenMetadata 전용 MySQL
  # ============================================
  openmetadata-mysql:
    image: mysql:8.0
    container_name: pms-openmetadata-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${OM_MYSQL_ROOT_PASSWORD:-openmetadata_root_password}
      MYSQL_DATABASE: openmetadata_db
      MYSQL_USER: openmetadata_user
      MYSQL_PASSWORD: ${OM_MYSQL_PASSWORD:-openmetadata_password}
    volumes:
      - openmetadata_mysql_data:/var/lib/mysql
    networks:
      - pms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${OM_MYSQL_ROOT_PASSWORD:-openmetadata_root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ============================================
  # Elasticsearch (메타데이터 검색 엔진)
  # ============================================
  openmetadata-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.15
    container_name: pms-openmetadata-elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
      - cluster.name=openmetadata-cluster
    volumes:
      - openmetadata_es_data:/usr/share/elasticsearch/data
    networks:
      - pms-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 1G

  # ============================================
  # OpenMetadata Server
  # ============================================
  openmetadata-server:
    image: openmetadata/server:1.3.1
    container_name: pms-openmetadata-server
    environment:
      # Database Configuration
      DB_HOST: openmetadata-mysql
      DB_PORT: 3306
      DB_USER: openmetadata_user
      DB_USER_PASSWORD: ${OM_MYSQL_PASSWORD:-openmetadata_password}
      DB_DRIVER_CLASS: com.mysql.cj.jdbc.Driver
      DB_SCHEME: mysql
      DB_USE_SSL: "false"
      OM_DATABASE: openmetadata_db
      
      # Elasticsearch Configuration
      ELASTICSEARCH_HOST: openmetadata-elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_SCHEME: http
      
      # Authentication (기본: basic, 추후 SSO 연동 가능)
      AUTHENTICATION_PROVIDER: basic
      AUTHENTICATION_PUBLIC_KEYS: '[http://localhost:8585/api/v1/system/config/jwks]'
      AUTHENTICATION_AUTHORITY: "http://localhost:8585/api/v1/system/config/jwks"
      AUTHENTICATION_CLIENT_ID: "openmetadata"
      
      # Server Configuration
      SERVER_HOST_API_URL: http://localhost:8585/api
      
      # Pipeline Service (Airflow 미사용 시)
      PIPELINE_SERVICE_CLIENT_ENABLED: "false"
      
      # Logging
      LOG_LEVEL: INFO
    ports:
      - "8585:8585"
    depends_on:
      openmetadata-mysql:
        condition: service_healthy
      openmetadata-elasticsearch:
        condition: service_healthy
    networks:
      - pms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/api/v1/system/version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ============================================
  # OpenMetadata Ingestion (데이터 수집 서비스)
  # ============================================
  openmetadata-ingestion:
    image: openmetadata/ingestion:1.3.1
    container_name: pms-openmetadata-ingestion
    environment:
      # Airflow 설정 (Local Executor)
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: mysql+pymysql://openmetadata_user:${OM_MYSQL_PASSWORD:-openmetadata_password}@openmetadata-mysql:3306/openmetadata_db
      
      # OpenMetadata 연결
      OPENMETADATA_SERVER_HOST: openmetadata-server
      OPENMETADATA_SERVER_PORT: 8585
      
      # PMS PostgreSQL 연결 정보 (인제스션용)
      PMS_POSTGRES_HOST: postgres
      PMS_POSTGRES_PORT: 5432
      PMS_POSTGRES_DB: ${POSTGRES_DB:-pms_db}
      PMS_POSTGRES_USER: ${POSTGRES_USER:-pms_user}
      PMS_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pms_password}
      
      # PMS Neo4j 연결 정보 (인제스션용)
      PMS_NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      PMS_NEO4J_USER: ${NEO4J_USER:-neo4j}
      PMS_NEO4J_PASSWORD: ${NEO4J_PASSWORD:-pmspassword123}
    depends_on:
      openmetadata-server:
        condition: service_healthy
    volumes:
      - openmetadata_ingestion_data:/opt/airflow
      - ./openmetadata/ingestion:/opt/airflow/dags:ro
    networks:
      - pms-network
    ports:
      - "8586:8080"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

# ============================================
# Volumes
# ============================================
volumes:
  openmetadata_mysql_data:
    driver: local
  openmetadata_es_data:
    driver: local
  openmetadata_ingestion_data:
    driver: local
